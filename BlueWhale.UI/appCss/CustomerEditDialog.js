define("app/vm/CustomerEditDialog","dojo/_base/declare app/util/_WidgetBase dojo/_base/lang dojo/on dojo/json chanjet/widget/Dialog csp/csp dojo/Stateful".split(" "),function(h,n,p,q,e,t,g,u){var r=g.Page,v=g.Edit,w=g.ViewTextWrapper,x=g.CustomerNameWrapper;q=h("app/vm/CustomerEditDialog",[n],{objId:null,customerDialog:null,errorMsg:null,customerEditPanel:null,postCreate:function(){this.errorMsg={};this.inherited(arguments)},show:function(a){var b="\u65b0\u589e\u4f01\u4e1a\u5ba2\u6237";this.objId&&
(b="\u7f16\u8f91\u4f01\u4e1a\u5ba2\u6237");var c=this,b=this.customerDialog=new t({"class":"customer",bottomButtons:[{label:"\u53d6\u6d88",sTag:"cancel",baseClass:"whiteButton"},{label:"\u4fdd\u5b58",sTag:"ok",baseClass:"whiteButton"}],title:b,autoDestroy:!0,contentMaxHeight:"480px",contentMinHeight:"360px",style:"width:750px;top:80px;",buttonClick:function(b,d,e){"ok"==e?c.customerEditPanel.checkValidation()&&(b=c.customerEditPanel.getData(),App.showLoading(),c._saveOrUpdateCustomer(b,a),App.bdstatEvent("\u5ba2\u6237\u5217\u8868-\u5ba2\u6237\u4fe1\u606f\u4fdd\u5b58")):
c.destroy()}});b.show();var d=this.customerEditPanel=new y({objId:this.objId,store:new u({})});b.addChild(d)},_isNew:function(a,b){if(!b&&0!=b)return!a==!b;if(b.id)return a==b.id;if(b.value)return a.value?a.value==b.value:a==b.value;if(a instanceof Date){var c=a.getMonth()+1,d=a.getDate();return a.getFullYear()+"-"+(10>c?"0"+c:c)+"-"+(10>d?"0"+d:d)==b}return p.isString(b)?a===b:a==b},_saveOrUpdateCustomer:function(a,b){if(!this.connecting){this.connecting=!0;var c=URL.customer,d=this;if(this.objId){var s=
this.customerEditPanel._cache,f=a.customValues,g=a.id,h=a.name;delete a.customValues;for(var k in a){var l=a[k];"owner"!=k&&d._isNew(l,s[k])&&(a[k]=null)}for(var m in f)l=f[m],d._isNew(l,s[m])&&(f[m]=null);a.customValues=f;a.id=g;a.name=h;dojo.isIE&&(a=e.parse(e.stringify(a).replace(/"null"/g,'""')));xhr.put(c,a,function(a){d.connecting=!1;App.hideLoading();a.mergeFlag&&d.alert({content:"\u5ba2\u6237\u91cd\u590d\u5566\uff0c\u6211\u4eec\u5df2\u5e2e\u60a8\u8fdb\u884c\u4e86\u5408\u5e76"});b&&b(a);d.destroy()},
function(){d.connecting=!1;App.hideLoading()})}else a.localId="-"+(new Date).getTime(),dojo.isIE&&(a=e.parse(e.stringify(a).replace(/"null"/g,'""'))),xhr.post(c,a,function(a){d.connecting=!1;App.hideLoading();a.mergeFlag&&d.alert({content:"\u5ba2\u6237\u91cd\u590d\u5566\uff0c\u6211\u4eec\u5df2\u5e2e\u60a8\u8fdb\u884c\u4e86\u5408\u5e76"});b&&b(a);d.destroy()},function(){d.connecting=!1;App.hideLoading()})}},destroy:function(){this.customerEditPanel.destroy();this.customerDialog.destroy();this.inherited(arguments)}});
var y=h("app.view.CustomerEditPanel",[n],{objId:null,store:{},callback:null,postCreate:function(){if(this.objId){var a=this;xhr.get({url:URL.customer+"/"+this.objId,success:function(b){a._cache=b;a.store=p.mixin({},b);a._initViewInterface();a.callback&&a.callback({domNode:a.domNode});a.editPane.adjustWidgetWidthAndHeight()}})}else this.store.set("owner",{id:App.user.userId,name:App.user.name,headPicture:App.user.headPicture}),this._initViewInterface(),this.callback&&this.callback({domNode:this.domNode}),
this.editPane.adjustWidgetWidthAndHeight();this.inherited(arguments)},_initViewInterface:function(){var a={layoutInfo:r.getLayout("Customer","edit"),metaDatas:r.getFieldMetadatas("Customer","edit"),showLabelColon:!0,labelAlianLeft:!0,showToggle:"none",data:this.store};a.metaDatas.owner.editable=!1;a.customWrappers={modifiedTime:function(a,c,d,e,f){return new w(c,d,e,f)},name:function(a,c,d,e,f){return new x(c,d,e,f)}};this.editPane=new v(a);this.editPane.placeAt(this.domNode);this.editPane.startup()},
checkValidation:function(){return 0<this.editPane.checkValidation().length&&this.editPane._started?!1:!0},getData:function(){var a=this.editPane.getData(),b={};this.objId&&(this.store={id:this.objId});for(var c in a)"modifiedTime"!=c&&(5<c.length&&"Field"==c.substring(0,5)?b[c]=a[c]:this.store[c]=a[c]instanceof Object?a[c].id?a[c].id:a[c].value:a[c]);this.store.customValues=b;return this.store}});return q});
